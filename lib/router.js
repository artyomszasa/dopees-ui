var __decorate = this && this.__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

import { dedupingMixin } from "@polymer/polymer/lib/utils/mixin.js";
import { property } from "@polymer/decorators/lib/decorators.js";
import { Uri } from "dopees-core/lib/uri.js";
import { fromBase64String } from "dopees-core/lib/string.js";
export var DopeRouter;

(function (DopeRouter) {
  function attachLinkHandlers(root) {
    root.addEventListener('click', ex => {
      const e = ex;

      if (e.shiftKey || e.ctrlKey || e.metaKey) {
        return;
      }

      if (e.target instanceof Element) {
        let target = e.target;

        while (target && target.tagName !== 'A' && !(target.getAttribute && target.getAttribute('data-page'))) {
          if (target.hasAttribute && target.hasAttribute('suppress-goto')) {
            return;
          }

          target = target.parentNode instanceof Element ? target.parentNode : null;
        }

        if (!target) {
          return;
        }

        if (target.hasAttribute && (target.hasAttribute('suppress-goto') || target.hasAttribute('draggable'))) {
          return;
        }

        const rawPage = target.getAttribute('data-page');

        if (!rawPage) {
          return;
        }

        e.preventDefault();
        e.stopPropagation();
        const page = JSON.parse(fromBase64String(rawPage));
        target.dispatchEvent(new CustomEvent('goto-page', {
          bubbles: true,
          composed: true,
          detail: {
            page,
            source: target
          }
        }));
      }
    }, true);
  }

  DopeRouter.attachLinkHandlers = attachLinkHandlers;
})(DopeRouter || (DopeRouter = {}));

export const DopeRouterMixin = dedupingMixin(base => {
  class DopeRouted extends base {
    constructor() {
      super(...arguments);
      this.__pageComponents = {};
    }

    get defaultComponent() {
      return 'admin-dashboard';
    }

    get defaultArguments() {
      return undefined;
    }

    ready() {
      super.ready(); // vissza gomb lekezelése

      window.addEventListener('popstate', e => {
        if (e.state) {
          this.initPage(e.state, true);
        }
      }, false); // kezdei állapot kilvasása url-ből

      const uri = Uri.from(window.location.href);
      const initialPage = {
        component: uri.path.substring(1).replace('/', '-') || this.defaultComponent,
        arguments: uri.path.substring(1).replace('/', '-') ? uri.queryParams : this.defaultArguments
      }; // külső layout-ban lévő linkek lekezelése.

      if (this.shadowRoot) {
        DopeRouter.attachLinkHandlers(this.shadowRoot); // oldalváltás lekezelése.

        this.shadowRoot.addEventListener('goto-page', ex => {
          const e = ex;
          e.preventDefault();
          e.stopPropagation();
          this.initPage(e.detail.page, false, !!e.detail.replace);
        }, true);
      }

      this.initPage(initialPage, false, true);
    }

    initPage(page, isPop, replace) {
      if (!page) {
        throw new Error('page not specified in initPage.');
      }

      let confirmLeave = Promise.resolve();

      if (this.__previousPage && this.__previousPage.beforeLeave) {
        confirmLeave = Promise.resolve(this.__previousPage.beforeLeave()); // dope.confirm('Az aktuális oldal tartalmaz nem mentett változást...', 'Biztosan vált oldalt?');
      }

      confirmLeave.then(() => {
        return this._loadComponent(page.component).then(null, () => this.notFound = true).then(() => {
          this.notFound = false;

          if (!isPop) {
            const uri = new Uri('');
            uri.path = '/' + page.component.replace('-', '/');
            uri.queryParams = page.arguments || {};

            if (replace) {
              window.history.replaceState(page, '', uri.href);
            } else {
              window.history.pushState(page, '', uri.href);
            }
          }

          this.currentPage = page;
        });
      }, () => {});
    }

    _currentPageChanged(page) {
      if (!this.notFound) {
        // wait for dom-if to apply changes
        setTimeout(() => {
          if (this.__previousPage) {
            this.__previousPage.leave();
          }

          const pageElement = this.shadowRoot && this.shadowRoot.querySelector(page.component);

          if (pageElement) {
            this.__previousPage = pageElement;
            pageElement.dispatchEvent(new CustomEvent('init', {
              detail: this.currentPage.arguments || {}
            }));
          } else {
            this.notFound = true;
          }
        }, 0);
      }
    }

    _loadComponent(component) {
      if (!this.__pageComponents[component]) {
        this.__pageComponents[component] = import(this._resolveComponentPath(component)).catch(() => null);
      }

      return this.__pageComponents[component];
    }

  }

  __decorate([property({
    type: Boolean,
    notify: true,
    reflectToAttribute: true
  })], DopeRouted.prototype, "notFound", void 0);

  __decorate([property({
    type: Object,
    notify: true,
    observer: '_currentPageChanged'
  })], DopeRouted.prototype, "currentPage", void 0);

  ;
  return DopeRouted;
});
export const DopeGotoMixin = dedupingMixin(base => class extends base {
  ready() {
    super.ready();

    if (this.shadowRoot) {
      DopeRouter.attachLinkHandlers(this.shadowRoot);
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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T0FBUjtBQUFpQixJQUFBLE1BQU0sRUFBRSxJQUF6QjtBQUErQixJQUFBLGtCQUFrQixFQUFFO0FBQW5ELEdBQUQsQ0FDVCxDQUFBLEUsb0JBQUEsRSxVQUFBLEUsS0FBbUIsQ0FBbkIsQ0FBQTs7QUFHQSxFQUFBLFVBQUEsQ0FBQSxDQURDLFFBQVEsQ0FBQztBQUFFLElBQUEsSUFBSSxFQUFFLE1BQVI7QUFBZ0IsSUFBQSxNQUFNLEVBQUUsSUFBeEI7QUFBOEIsSUFBQSxRQUFRLEVBQUU7QUFBeEMsR0FBRCxDQUNULENBQUEsRSxvQkFBQSxFLGFBQUEsRSxLQUF1QixDQUF2QixDQUFBOztBQXFGRDtBQUNELFNBQXNDLFVBQXRDO0FBQ0QsQ0FoRzJDLENBQXJDO0FBa0dQLE9BQU8sTUFBTSxhQUFhLEdBQUcsYUFBYSxDQUE0QixJQUEzQixJQUFzRCxjQUFxQyxJQUFyQyxDQUEwQztBQUN6SSxFQUFBLEtBQUssR0FBQTtBQUNELFVBQU0sS0FBTjs7QUFDQSxRQUFJLEtBQUssVUFBVCxFQUFxQjtBQUNuQixNQUFBLFVBQVUsQ0FBQyxrQkFBWCxDQUE4QixLQUFLLFVBQW5DO0FBQ0Q7QUFDSjs7QUFOd0ksQ0FBakcsQ0FBbkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZWR1cGluZ01peGluIH0gZnJvbSAnQHBvbHltZXIvcG9seW1lci9saWIvdXRpbHMvbWl4aW4nO1xuaW1wb3J0IHsgcHJvcGVydHkgfSBmcm9tICdAcG9seW1lci9kZWNvcmF0b3JzL2xpYi9kZWNvcmF0b3JzJztcbmltcG9ydCB7IFVyaSB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi91cmknO1xuaW1wb3J0IHsgZnJvbUJhc2U2NFN0cmluZyB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi9zdHJpbmcnO1xuaW1wb3J0IHsgUG9seW1lckVsZW1lbnQgfSBmcm9tICdAcG9seW1lci9wb2x5bWVyL3BvbHltZXItZWxlbWVudCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFnZURhdGEge1xuICBjb21wb25lbnQ6IHN0cmluZztcbiAgYXJndW1lbnRzOiBhbnk7XG59XG5cbmludGVyZmFjZSBQYWdlRGF0YUFyZ3Mge1xuICBwYWdlOiBQYWdlRGF0YTtcbiAgcmVwbGFjZT86IGJvb2xlYW47XG59XG5cbmludGVyZmFjZSBOYW1lZFByb21pc2VNYXAge1xuICBba2V5OiBzdHJpbmddOiBQcm9taXNlPGFueT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RyaW5nTWFwIHtcbiAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERvcGVSb3V0ZXIge1xuICBub3RGb3VuZDogYm9vbGVhbjtcbiAgY3VycmVudFBhZ2U6IFBhZ2VEYXRhO1xuICBkZWZhdWx0Q29tcG9uZW50OiBzdHJpbmc7XG4gIGRlZmF1bHRBcmd1bWVudHM/OiBTdHJpbmdNYXA7XG4gIGluaXRQYWdlKHBhZ2U6IFBhZ2VEYXRhLCBpc1BvcD86IGJvb2xlYW4sIHJlcGxhY2U/OiBib29sZWFuKTogdm9pZDtcbiAgX2N1cnJlbnRQYWdlQ2hhbmdlZChwYWdlOiBQYWdlRGF0YSk6IHZvaWQ7XG4gIF9yZXNvbHZlQ29tcG9uZW50UGF0aChjb21wb25lbnQ6IHN0cmluZyk6IHN0cmluZztcbiAgX2xvYWRDb21wb25lbnQgKGNvbXBvbmVudDogc3RyaW5nKTogUHJvbWlzZTxhbnk+O1xufVxuXG5leHBvcnQgbmFtZXNwYWNlIERvcGVSb3V0ZXIge1xuICBleHBvcnQgZnVuY3Rpb24gYXR0YWNoTGlua0hhbmRsZXJzKHJvb3Q6IE5vZGUpIHtcbiAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV4OiBFdmVudCkgPT4ge1xuICAgICAgY29uc3QgZSA9IDxNb3VzZUV2ZW50PmV4O1xuICAgICAgaWYgKGUuc2hpZnRLZXkgfHwgZS5jdHJsS2V5IHx8IGUubWV0YUtleSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAoZS50YXJnZXQgaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgIGxldCB0YXJnZXQ6IEVsZW1lbnR8dW5kZWZpbmVkfG51bGwgPSBlLnRhcmdldDtcbiAgICAgICAgd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQudGFnTmFtZSAhPT0gJ0EnICYmICEodGFyZ2V0LmdldEF0dHJpYnV0ZSAmJiB0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXBhZ2UnKSkpIHtcbiAgICAgICAgICBpZiAodGFyZ2V0Lmhhc0F0dHJpYnV0ZSAmJiB0YXJnZXQuaGFzQXR0cmlidXRlKCdzdXBwcmVzcy1nb3RvJykpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGUgaW5zdGFuY2VvZiBFbGVtZW50ID8gdGFyZ2V0LnBhcmVudE5vZGUgOiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0YXJnZXQuaGFzQXR0cmlidXRlICYmICh0YXJnZXQuaGFzQXR0cmlidXRlKCdzdXBwcmVzcy1nb3RvJykgfHwgdGFyZ2V0Lmhhc0F0dHJpYnV0ZSgnZHJhZ2dhYmxlJykpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJhd1BhZ2UgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXBhZ2UnKTtcbiAgICAgICAgaWYgKCFyYXdQYWdlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgY29uc3QgcGFnZSA9IDxQYWdlRGF0YT5KU09OLnBhcnNlKGZyb21CYXNlNjRTdHJpbmcocmF3UGFnZSkpO1xuICAgICAgICB0YXJnZXQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2dvdG8tcGFnZScsIHtcbiAgICAgICAgICBidWJibGVzOiB0cnVlLFxuICAgICAgICAgIGNvbXBvc2VkOiB0cnVlLFxuICAgICAgICAgIGRldGFpbDoge1xuICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgIHNvdXJjZTogdGFyZ2V0XG4gICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgICB9XG4gICAgfSwgdHJ1ZSlcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEN0b3I8VD4ge1xuICBuZXcgKC4uLmFyZ3M6IGFueVtdKTogVDtcbn1cblxuZXhwb3J0IGNvbnN0IERvcGVSb3V0ZXJNaXhpbiA9IGRlZHVwaW5nTWl4aW4oPFQgZXh0ZW5kcyBQb2x5bWVyRWxlbWVudD4oYmFzZTogQ3RvcjxUPikgPT4ge1xuICBhYnN0cmFjdCBjbGFzcyBEb3BlUm91dGVkIGV4dGVuZHMgKDxDdG9yPFBvbHltZXJFbGVtZW50Pj5iYXNlKSB7XG4gICAgX19wYWdlQ29tcG9uZW50czogTmFtZWRQcm9taXNlTWFwID0ge307XG4gICAgX19wcmV2aW91c1BhZ2U6IGFueTsgLy9GSVhNRTogdHlwaW5nXG5cbiAgICBAcHJvcGVydHkoeyB0eXBlOiBCb29sZWFuLCBub3RpZnk6IHRydWUsIHJlZmxlY3RUb0F0dHJpYnV0ZTogdHJ1ZSB9KVxuICAgIG5vdEZvdW5kITogYm9vbGVhbjtcblxuICAgIEBwcm9wZXJ0eSh7IHR5cGU6IE9iamVjdCwgbm90aWZ5OiB0cnVlLCBvYnNlcnZlcjogJ19jdXJyZW50UGFnZUNoYW5nZWQnIH0pXG4gICAgY3VycmVudFBhZ2UhOiBQYWdlRGF0YTtcblxuICAgIGdldCBkZWZhdWx0Q29tcG9uZW50ICgpIHsgcmV0dXJuICdhZG1pbi1kYXNoYm9hcmQnOyB9XG5cbiAgICBnZXQgZGVmYXVsdEFyZ3VtZW50cyAoKSB7IHJldHVybiB1bmRlZmluZWQ7IH1cblxuICAgIHJlYWR5ICgpIHtcbiAgICAgICAgc3VwZXIucmVhZHkoKTtcbiAgICAgICAgLy8gdmlzc3phIGdvbWIgbGVrZXplbMOpc2VcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgZSA9PiB7XG4gICAgICAgICAgICBpZiAoZS5zdGF0ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuaW5pdFBhZ2UoZS5zdGF0ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIGZhbHNlKTtcbiAgICAgICAgLy8ga2V6ZGVpIMOhbGxhcG90IGtpbHZhc8Ohc2EgdXJsLWLFkWxcbiAgICAgICAgY29uc3QgdXJpID0gVXJpLmZyb20od2luZG93LmxvY2F0aW9uLmhyZWYpO1xuICAgICAgICBjb25zdCBpbml0aWFsUGFnZSA9IHtcbiAgICAgICAgICAgIGNvbXBvbmVudDogKHVyaS5wYXRoLnN1YnN0cmluZygxKS5yZXBsYWNlKCcvJywgJy0nKSB8fCB0aGlzLmRlZmF1bHRDb21wb25lbnQpLFxuICAgICAgICAgICAgYXJndW1lbnRzOiAodXJpLnBhdGguc3Vic3RyaW5nKDEpLnJlcGxhY2UoJy8nLCAnLScpID8gdXJpLnF1ZXJ5UGFyYW1zIDogdGhpcy5kZWZhdWx0QXJndW1lbnRzKVxuICAgICAgICB9O1xuICAgICAgICAvLyBrw7xsc8WRIGxheW91dC1iYW4gbMOpdsWRIGxpbmtlayBsZWtlemVsw6lzZS5cbiAgICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCkge1xuICAgICAgICAgIERvcGVSb3V0ZXIuYXR0YWNoTGlua0hhbmRsZXJzKHRoaXMuc2hhZG93Um9vdCk7XG4gICAgICAgICAgLy8gb2xkYWx2w6FsdMOhcyBsZWtlemVsw6lzZS5cbiAgICAgICAgICB0aGlzLnNoYWRvd1Jvb3QuYWRkRXZlbnRMaXN0ZW5lcignZ290by1wYWdlJywgZXggPT4ge1xuICAgICAgICAgICAgY29uc3QgZSA9IDxDdXN0b21FdmVudDxQYWdlRGF0YUFyZ3M+PmV4O1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIHRoaXMuaW5pdFBhZ2UoZS5kZXRhaWwucGFnZSwgZmFsc2UsICEhZS5kZXRhaWwucmVwbGFjZSk7XG4gICAgICAgICAgfSwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pbml0UGFnZShpbml0aWFsUGFnZSwgZmFsc2UsIHRydWUpO1xuICAgIH1cbiAgICBpbml0UGFnZSAocGFnZTogUGFnZURhdGEsIGlzUG9wPzogYm9vbGVhbiwgcmVwbGFjZT86IGJvb2xlYW4pIHtcbiAgICAgICAgaWYgKCFwYWdlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3BhZ2Ugbm90IHNwZWNpZmllZCBpbiBpbml0UGFnZS4nKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgY29uZmlybUxlYXZlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIGlmICh0aGlzLl9fcHJldmlvdXNQYWdlICYmIHRoaXMuX19wcmV2aW91c1BhZ2UuYmVmb3JlTGVhdmUpIHtcbiAgICAgICAgICAgIGNvbmZpcm1MZWF2ZSA9IFByb21pc2UucmVzb2x2ZSh0aGlzLl9fcHJldmlvdXNQYWdlLmJlZm9yZUxlYXZlKCkpOyAvLyBkb3BlLmNvbmZpcm0oJ0F6IGFrdHXDoWxpcyBvbGRhbCB0YXJ0YWxtYXogbmVtIG1lbnRldHQgdsOhbHRvesOhc3QuLi4nLCAnQml6dG9zYW4gdsOhbHQgb2xkYWx0PycpO1xuICAgICAgICB9XG4gICAgICAgIGNvbmZpcm1MZWF2ZS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9sb2FkQ29tcG9uZW50KHBhZ2UuY29tcG9uZW50KVxuICAgICAgICAgICAgICAgIC50aGVuKG51bGwsICgpID0+IHRoaXMubm90Rm91bmQgPSB0cnVlKVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RGb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1cmkgPSBuZXcgVXJpKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVyaS5wYXRoID0gJy8nICsgcGFnZS5jb21wb25lbnQucmVwbGFjZSgnLScsICcvJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmkucXVlcnlQYXJhbXMgPSBwYWdlLmFyZ3VtZW50cyB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXBsYWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHBhZ2UsICcnLCB1cmkuaHJlZik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShwYWdlLCAnJywgdXJpLmhyZWYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSBwYWdlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCAoKSA9PiB7fSk7XG5cbiAgICB9XG4gICAgX2N1cnJlbnRQYWdlQ2hhbmdlZCAocGFnZTogUGFnZURhdGEpIHtcbiAgICAgIGlmICghdGhpcy5ub3RGb3VuZCkge1xuICAgICAgICAvLyB3YWl0IGZvciBkb20taWYgdG8gYXBwbHkgY2hhbmdlc1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5fX3ByZXZpb3VzUGFnZSkge1xuICAgICAgICAgICAgdGhpcy5fX3ByZXZpb3VzUGFnZS5sZWF2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBwYWdlRWxlbWVudCA9IHRoaXMuc2hhZG93Um9vdCAmJiB0aGlzLnNoYWRvd1Jvb3QucXVlcnlTZWxlY3RvcihwYWdlLmNvbXBvbmVudCk7XG4gICAgICAgICAgaWYgKHBhZ2VFbGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLl9fcHJldmlvdXNQYWdlID0gcGFnZUVsZW1lbnQ7XG4gICAgICAgICAgICBwYWdlRWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnaW5pdCcsIHsgZGV0YWlsIDogdGhpcy5jdXJyZW50UGFnZS5hcmd1bWVudHMgfHwgeyB9IH0pKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RGb3VuZCA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9LCAwKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYWJzdHJhY3QgX3Jlc29sdmVDb21wb25lbnRQYXRoKGNvbXBvbmVudDogc3RyaW5nKTogc3RyaW5nO1xuICAgIF9sb2FkQ29tcG9uZW50IChjb21wb25lbnQ6IHN0cmluZykge1xuICAgICAgaWYgKCF0aGlzLl9fcGFnZUNvbXBvbmVudHNbY29tcG9uZW50XSkge1xuICAgICAgICB0aGlzLl9fcGFnZUNvbXBvbmVudHNbY29tcG9uZW50XSA9IGltcG9ydCh0aGlzLl9yZXNvbHZlQ29tcG9uZW50UGF0aChjb21wb25lbnQpKS5jYXRjaCgoKSA9PiBudWxsKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLl9fcGFnZUNvbXBvbmVudHNbY29tcG9uZW50XTtcbiAgICB9XG4gIH07XG4gIHJldHVybiA8Q3RvcjxUICYgRG9wZVJvdXRlcj4+PHVua25vd24+RG9wZVJvdXRlZDtcbn0pO1xuXG5leHBvcnQgY29uc3QgRG9wZUdvdG9NaXhpbiA9IGRlZHVwaW5nTWl4aW4oPFQgZXh0ZW5kcyBQb2x5bWVyRWxlbWVudD4oYmFzZTogQ3RvcjxUPikgPT4gPEN0b3I8VD4+Y2xhc3MgZXh0ZW5kcyAoPEN0b3I8UG9seW1lckVsZW1lbnQ+PmJhc2UpIHtcbiAgcmVhZHkgKCkge1xuICAgICAgc3VwZXIucmVhZHkoKTtcbiAgICAgIGlmICh0aGlzLnNoYWRvd1Jvb3QpIHtcbiAgICAgICAgRG9wZVJvdXRlci5hdHRhY2hMaW5rSGFuZGxlcnModGhpcy5zaGFkb3dSb290KTtcbiAgICAgIH1cbiAgfVxufSk7Il0sInNvdXJjZVJvb3QiOiIifQ==