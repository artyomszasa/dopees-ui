var __decorate = this && this.__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

import { dedupingMixin } from "@polymer/polymer/lib/utils/mixin.js";
import { property } from "@polymer/decorators/lib/decorators.js";
import { Uri } from "dopees-core/lib/uri.js";
import { fromBase64String } from "dopees-core/lib/string.js";
export var DopeRouter;

(function (DopeRouter) {
  function attachLinkHandlers(root) {
    root.addEventListener('click', ex => {
      const e = ex;

      if (e.shiftKey || e.ctrlKey || e.metaKey) {
        return;
      }

      if (e.target instanceof Element) {
        let target = e.target;

        while (target && target.tagName !== 'A' && !(target.getAttribute && target.getAttribute('data-page'))) {
          if (target.hasAttribute && target.hasAttribute('suppress-goto')) {
            return;
          }

          target = target.parentNode instanceof Element ? target.parentNode : null;
        }

        if (!target) {
          return;
        }

        if (target.hasAttribute && (target.hasAttribute('suppress-goto') || target.hasAttribute('draggable'))) {
          return;
        }

        const rawPage = target.getAttribute('data-page');

        if (!rawPage) {
          return;
        }

        e.preventDefault();
        e.stopPropagation();
        const page = JSON.parse(fromBase64String(rawPage));
        target.dispatchEvent(new CustomEvent('goto-page', {
          bubbles: true,
          composed: true,
          detail: {
            page,
            source: target
          }
        }));
      }
    }, true);
  }

  DopeRouter.attachLinkHandlers = attachLinkHandlers;
})(DopeRouter || (DopeRouter = {}));

export const DopeRouterMixin = dedupingMixin(base => {
  class DopeRouted extends base {
    constructor() {
      super(...arguments);
      this.__pageComponents = {};
    }

    get defaultComponent() {
      return 'admin-dashboard';
    }

    get defaultArguments() {
      return undefined;
    }

    ready() {
      super.ready(); // vissza gomb lekezelése

      window.addEventListener('popstate', e => {
        if (e.state) {
          this.initPage(e.state, true);
        }
      }, false); // kezdei állapot kilvasása url-ből

      const uri = Uri.from(window.location.href);
      const initialPage = {
        component: uri.path.substring(1).replace('/', '-') || this.defaultComponent,
        arguments: uri.path.substring(1).replace('/', '-') ? uri.queryParams : this.defaultArguments
      }; // külső layout-ban lévő linkek lekezelése.

      if (this.shadowRoot) {
        DopeRouter.attachLinkHandlers(this.shadowRoot); // oldalváltás lekezelése.

        this.shadowRoot.addEventListener('goto-page', ex => {
          const e = ex;
          e.preventDefault();
          e.stopPropagation();

          if (!e.detail) {
            this.initPage({
              component: this.defaultComponent,
              arguments: this.defaultArguments
            }, false, false);
          } else {
            this.initPage(e.detail.page, false, !!e.detail.replace);
          }
        }, true);
      }

      this.initPage(initialPage, false, true);
    }

    async initPage(page, isPop, replace) {
      if (!page) {
        throw new Error('page not specified in initPage.');
      }

      let confirmLeave = true;

      if (this.__previousPage && this.__previousPage.beforeLeave) {
        try {
          confirmLeave = await Promise.resolve(this.__previousPage.beforeLeave());
        } catch (e) {
          console.warn(e);
          confirmLeave = false;
        }
      }

      if (confirmLeave) {
        let loaded;

        try {
          await this._loadComponent(page.component);
          loaded = true;
        } catch (e) {
          console.warn(e);
          loaded = false;
        }

        if (!loaded) {
          this.notFound = true;
        } else {
          this.notFound = false;

          if (!isPop) {
            const uri = new Uri('');
            uri.path = '/' + page.component.replace('-', '/');
            uri.queryParams = page.arguments || {};

            if (replace) {
              window.history.replaceState(page, '', uri.href);
            } else {
              window.history.pushState(page, '', uri.href);
            }
          }

          this.currentPage = page;
        }
      }
    }

    _currentPageChanged(page) {
      if (!this.notFound) {
        // wait for dom-if to apply changes
        setTimeout(() => {
          if (this.__previousPage) {
            this.__previousPage.leave();
          }

          const pageElement = this.shadowRoot && this.shadowRoot.querySelector(page.component);

          if (pageElement) {
            this.__previousPage = pageElement;
            pageElement.dispatchEvent(new CustomEvent('init', {
              detail: this.currentPage.arguments || {}
            }));
          } else {
            this.notFound = true;
          }
        }, 0);
      }
    }

    _loadComponent(component) {
      if (!this.__pageComponents[component]) {
        this.__pageComponents[component] = import(this._resolveComponentPath(component)).catch(() => null);
      }

      return this.__pageComponents[component];
    }

  }

  __decorate([property({
    type: Boolean,
    notify: true,
    reflectToAttribute: true
  })], DopeRouted.prototype, "notFound", void 0);

  __decorate([property({
    type: Object,
    notify: true,
    observer: '_currentPageChanged'
  })], DopeRouted.prototype, "currentPage", void 0);

  ;
  return DopeRouted;
});
export const DopeGotoMixin = dedupingMixin(base => class extends base {
  ready() {
    super.ready();

    if (this.shadowRoot) {
      DopeRouter.attachLinkHandlers(this.shadowRoot);
    }
  }

});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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ZHVwaW5nTWl4aW4gfSBmcm9tICdAcG9seW1lci9wb2x5bWVyL2xpYi91dGlscy9taXhpbic7XG5pbXBvcnQgeyBwcm9wZXJ0eSB9IGZyb20gJ0Bwb2x5bWVyL2RlY29yYXRvcnMvbGliL2RlY29yYXRvcnMnO1xuaW1wb3J0IHsgVXJpIH0gZnJvbSAnZG9wZWVzLWNvcmUvbGliL3VyaSc7XG5pbXBvcnQgeyBmcm9tQmFzZTY0U3RyaW5nIH0gZnJvbSAnZG9wZWVzLWNvcmUvbGliL3N0cmluZyc7XG5pbXBvcnQgeyBQb2x5bWVyRWxlbWVudCB9IGZyb20gJ0Bwb2x5bWVyL3BvbHltZXIvcG9seW1lci1lbGVtZW50JztcblxuZXhwb3J0IGludGVyZmFjZSBQYWdlRGF0YSB7XG4gIGNvbXBvbmVudDogc3RyaW5nO1xuICBhcmd1bWVudHM6IGFueTtcbn1cblxuaW50ZXJmYWNlIFBhZ2VEYXRhQXJncyB7XG4gIHBhZ2U6IFBhZ2VEYXRhO1xuICByZXBsYWNlPzogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIE5hbWVkUHJvbWlzZU1hcCB7XG4gIFtrZXk6IHN0cmluZ106IFByb21pc2U8YW55Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdHJpbmdNYXAge1xuICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRG9wZVJvdXRlciB7XG4gIG5vdEZvdW5kOiBib29sZWFuO1xuICBjdXJyZW50UGFnZTogUGFnZURhdGE7XG4gIGRlZmF1bHRDb21wb25lbnQ6IHN0cmluZztcbiAgZGVmYXVsdEFyZ3VtZW50cz86IFN0cmluZ01hcDtcbiAgaW5pdFBhZ2UocGFnZTogUGFnZURhdGEsIGlzUG9wPzogYm9vbGVhbiwgcmVwbGFjZT86IGJvb2xlYW4pOiB2b2lkO1xuICBfY3VycmVudFBhZ2VDaGFuZ2VkKHBhZ2U6IFBhZ2VEYXRhKTogdm9pZDtcbiAgX3Jlc29sdmVDb21wb25lbnRQYXRoKGNvbXBvbmVudDogc3RyaW5nKTogc3RyaW5nO1xuICBfbG9hZENvbXBvbmVudCAoY29tcG9uZW50OiBzdHJpbmcpOiBQcm9taXNlPGFueT47XG59XG5cbmV4cG9ydCBuYW1lc3BhY2UgRG9wZVJvdXRlciB7XG4gIGV4cG9ydCBmdW5jdGlvbiBhdHRhY2hMaW5rSGFuZGxlcnMocm9vdDogTm9kZSkge1xuICAgIHJvb3QuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZXg6IEV2ZW50KSA9PiB7XG4gICAgICBjb25zdCBlID0gPE1vdXNlRXZlbnQ+ZXg7XG4gICAgICBpZiAoZS5zaGlmdEtleSB8fCBlLmN0cmxLZXkgfHwgZS5tZXRhS2V5KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmIChlLnRhcmdldCBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgICAgbGV0IHRhcmdldDogRWxlbWVudHx1bmRlZmluZWR8bnVsbCA9IGUudGFyZ2V0O1xuICAgICAgICB3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC50YWdOYW1lICE9PSAnQScgJiYgISh0YXJnZXQuZ2V0QXR0cmlidXRlICYmIHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcGFnZScpKSkge1xuICAgICAgICAgIGlmICh0YXJnZXQuaGFzQXR0cmlidXRlICYmIHRhcmdldC5oYXNBdHRyaWJ1dGUoJ3N1cHByZXNzLWdvdG8nKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQgPyB0YXJnZXQucGFyZW50Tm9kZSA6IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0YXJnZXQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRhcmdldC5oYXNBdHRyaWJ1dGUgJiYgKHRhcmdldC5oYXNBdHRyaWJ1dGUoJ3N1cHByZXNzLWdvdG8nKSB8fCB0YXJnZXQuaGFzQXR0cmlidXRlKCdkcmFnZ2FibGUnKSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmF3UGFnZSA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcGFnZScpO1xuICAgICAgICBpZiAoIXJhd1BhZ2UpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBjb25zdCBwYWdlID0gPFBhZ2VEYXRhPkpTT04ucGFyc2UoZnJvbUJhc2U2NFN0cmluZyhyYXdQYWdlKSk7XG4gICAgICAgIHRhcmdldC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnZ290by1wYWdlJywge1xuICAgICAgICAgIGJ1YmJsZXM6IHRydWUsXG4gICAgICAgICAgY29tcG9zZWQ6IHRydWUsXG4gICAgICAgICAgZGV0YWlsOiB7XG4gICAgICAgICAgICBwYWdlLFxuICAgICAgICAgICAgc291cmNlOiB0YXJnZXRcbiAgICAgICAgICB9XG4gICAgICAgIH0pKTtcbiAgICAgIH1cbiAgICB9LCB0cnVlKVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3RvcjxUPiB7XG4gIG5ldyAoLi4uYXJnczogYW55W10pOiBUO1xufVxuXG5leHBvcnQgY29uc3QgRG9wZVJvdXRlck1peGluID0gZGVkdXBpbmdNaXhpbig8VCBleHRlbmRzIFBvbHltZXJFbGVtZW50PihiYXNlOiBDdG9yPFQ+KSA9PiB7XG4gIGFic3RyYWN0IGNsYXNzIERvcGVSb3V0ZWQgZXh0ZW5kcyAoPEN0b3I8UG9seW1lckVsZW1lbnQ+PmJhc2UpIHtcbiAgICBfX3BhZ2VDb21wb25lbnRzOiBOYW1lZFByb21pc2VNYXAgPSB7fTtcbiAgICBfX3ByZXZpb3VzUGFnZTogYW55OyAvL0ZJWE1FOiB0eXBpbmdcblxuICAgIEBwcm9wZXJ0eSh7IHR5cGU6IEJvb2xlYW4sIG5vdGlmeTogdHJ1ZSwgcmVmbGVjdFRvQXR0cmlidXRlOiB0cnVlIH0pXG4gICAgbm90Rm91bmQhOiBib29sZWFuO1xuXG4gICAgQHByb3BlcnR5KHsgdHlwZTogT2JqZWN0LCBub3RpZnk6IHRydWUsIG9ic2VydmVyOiAnX2N1cnJlbnRQYWdlQ2hhbmdlZCcgfSlcbiAgICBjdXJyZW50UGFnZSE6IFBhZ2VEYXRhO1xuXG4gICAgZ2V0IGRlZmF1bHRDb21wb25lbnQgKCkgeyByZXR1cm4gJ2FkbWluLWRhc2hib2FyZCc7IH1cblxuICAgIGdldCBkZWZhdWx0QXJndW1lbnRzICgpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfVxuXG4gICAgcmVhZHkgKCkge1xuICAgICAgICBzdXBlci5yZWFkeSgpO1xuICAgICAgICAvLyB2aXNzemEgZ29tYiBsZWtlemVsw6lzZVxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBlID0+IHtcbiAgICAgICAgICAgIGlmIChlLnN0YXRlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pbml0UGFnZShlLnN0YXRlLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgZmFsc2UpO1xuICAgICAgICAvLyBrZXpkZWkgw6FsbGFwb3Qga2lsdmFzw6FzYSB1cmwtYsWRbFxuICAgICAgICBjb25zdCB1cmkgPSBVcmkuZnJvbSh3aW5kb3cubG9jYXRpb24uaHJlZik7XG4gICAgICAgIGNvbnN0IGluaXRpYWxQYWdlID0ge1xuICAgICAgICAgIGNvbXBvbmVudDogKHVyaS5wYXRoLnN1YnN0cmluZygxKS5yZXBsYWNlKCcvJywgJy0nKSB8fCB0aGlzLmRlZmF1bHRDb21wb25lbnQpLFxuICAgICAgICAgIGFyZ3VtZW50czogKHVyaS5wYXRoLnN1YnN0cmluZygxKS5yZXBsYWNlKCcvJywgJy0nKSA/IHVyaS5xdWVyeVBhcmFtcyA6IHRoaXMuZGVmYXVsdEFyZ3VtZW50cylcbiAgICAgICAgfTtcbiAgICAgICAgLy8ga8O8bHPFkSBsYXlvdXQtYmFuIGzDqXbFkSBsaW5rZWsgbGVrZXplbMOpc2UuXG4gICAgICAgIGlmICh0aGlzLnNoYWRvd1Jvb3QpIHtcbiAgICAgICAgICBEb3BlUm91dGVyLmF0dGFjaExpbmtIYW5kbGVycyh0aGlzLnNoYWRvd1Jvb3QpO1xuICAgICAgICAgIC8vIG9sZGFsdsOhbHTDoXMgbGVrZXplbMOpc2UuXG4gICAgICAgICAgdGhpcy5zaGFkb3dSb290LmFkZEV2ZW50TGlzdGVuZXIoJ2dvdG8tcGFnZScsIGV4ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGUgPSA8Q3VzdG9tRXZlbnQ8UGFnZURhdGFBcmdzfG51bGw+PmV4O1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGlmICghZS5kZXRhaWwpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbml0UGFnZSh7IGNvbXBvbmVudDogdGhpcy5kZWZhdWx0Q29tcG9uZW50LCBhcmd1bWVudHM6IHRoaXMuZGVmYXVsdEFyZ3VtZW50cyB9LCBmYWxzZSwgZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5pbml0UGFnZShlLmRldGFpbC5wYWdlLCBmYWxzZSwgISFlLmRldGFpbC5yZXBsYWNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmluaXRQYWdlKGluaXRpYWxQYWdlLCBmYWxzZSwgdHJ1ZSk7XG4gICAgfVxuICAgIGFzeW5jIGluaXRQYWdlIChwYWdlOiBQYWdlRGF0YSwgaXNQb3A/OiBib29sZWFuLCByZXBsYWNlPzogYm9vbGVhbikge1xuICAgICAgaWYgKCFwYWdlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigncGFnZSBub3Qgc3BlY2lmaWVkIGluIGluaXRQYWdlLicpO1xuICAgICAgfVxuICAgICAgbGV0IGNvbmZpcm1MZWF2ZSA9IHRydWU7XG4gICAgICBpZiAodGhpcy5fX3ByZXZpb3VzUGFnZSAmJiB0aGlzLl9fcHJldmlvdXNQYWdlLmJlZm9yZUxlYXZlKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uZmlybUxlYXZlID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlPGJvb2xlYW4+KHRoaXMuX19wcmV2aW91c1BhZ2UuYmVmb3JlTGVhdmUoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oZSk7XG4gICAgICAgICAgY29uZmlybUxlYXZlID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChjb25maXJtTGVhdmUpIHtcbiAgICAgICAgbGV0IGxvYWRlZDogYm9vbGVhbjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLl9sb2FkQ29tcG9uZW50KHBhZ2UuY29tcG9uZW50KTtcbiAgICAgICAgICBsb2FkZWQgPSB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgICAgIGxvYWRlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghbG9hZGVkKSB7XG4gICAgICAgICAgdGhpcy5ub3RGb3VuZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5ub3RGb3VuZCA9IGZhbHNlO1xuICAgICAgICAgIGlmICghaXNQb3ApIHtcbiAgICAgICAgICAgIGNvbnN0IHVyaSA9IG5ldyBVcmkoJycpO1xuICAgICAgICAgICAgdXJpLnBhdGggPSAnLycgKyBwYWdlLmNvbXBvbmVudC5yZXBsYWNlKCctJywgJy8nKTtcbiAgICAgICAgICAgIHVyaS5xdWVyeVBhcmFtcyA9IHBhZ2UuYXJndW1lbnRzIHx8IHt9O1xuICAgICAgICAgICAgaWYgKHJlcGxhY2UpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUocGFnZSwgJycsIHVyaS5ocmVmKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKHBhZ2UsICcnLCB1cmkuaHJlZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSBwYWdlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIF9jdXJyZW50UGFnZUNoYW5nZWQgKHBhZ2U6IFBhZ2VEYXRhKSB7XG4gICAgICBpZiAoIXRoaXMubm90Rm91bmQpIHtcbiAgICAgICAgLy8gd2FpdCBmb3IgZG9tLWlmIHRvIGFwcGx5IGNoYW5nZXNcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuX19wcmV2aW91c1BhZ2UpIHtcbiAgICAgICAgICAgIHRoaXMuX19wcmV2aW91c1BhZ2UubGVhdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgcGFnZUVsZW1lbnQgPSB0aGlzLnNoYWRvd1Jvb3QgJiYgdGhpcy5zaGFkb3dSb290LnF1ZXJ5U2VsZWN0b3IocGFnZS5jb21wb25lbnQpO1xuICAgICAgICAgIGlmIChwYWdlRWxlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5fX3ByZXZpb3VzUGFnZSA9IHBhZ2VFbGVtZW50O1xuICAgICAgICAgICAgcGFnZUVsZW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ2luaXQnLCB7IGRldGFpbCA6IHRoaXMuY3VycmVudFBhZ2UuYXJndW1lbnRzIHx8IHsgfSB9KSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubm90Rm91bmQgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgMCk7XG4gICAgICB9XG4gICAgfVxuICAgIGFic3RyYWN0IF9yZXNvbHZlQ29tcG9uZW50UGF0aChjb21wb25lbnQ6IHN0cmluZyk6IHN0cmluZztcbiAgICBfbG9hZENvbXBvbmVudCAoY29tcG9uZW50OiBzdHJpbmcpIHtcbiAgICAgIGlmICghdGhpcy5fX3BhZ2VDb21wb25lbnRzW2NvbXBvbmVudF0pIHtcbiAgICAgICAgdGhpcy5fX3BhZ2VDb21wb25lbnRzW2NvbXBvbmVudF0gPSBpbXBvcnQodGhpcy5fcmVzb2x2ZUNvbXBvbmVudFBhdGgoY29tcG9uZW50KSkuY2F0Y2goKCkgPT4gbnVsbCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5fX3BhZ2VDb21wb25lbnRzW2NvbXBvbmVudF07XG4gICAgfVxuICB9O1xuICByZXR1cm4gPEN0b3I8VCAmIERvcGVSb3V0ZXI+Pjx1bmtub3duPkRvcGVSb3V0ZWQ7XG59KTtcblxuZXhwb3J0IGNvbnN0IERvcGVHb3RvTWl4aW4gPSBkZWR1cGluZ01peGluKDxUIGV4dGVuZHMgUG9seW1lckVsZW1lbnQ+KGJhc2U6IEN0b3I8VD4pID0+IDxDdG9yPFQ+PmNsYXNzIGV4dGVuZHMgKDxDdG9yPFBvbHltZXJFbGVtZW50Pj5iYXNlKSB7XG4gIHJlYWR5ICgpIHtcbiAgICAgIHN1cGVyLnJlYWR5KCk7XG4gICAgICBpZiAodGhpcy5zaGFkb3dSb290KSB7XG4gICAgICAgIERvcGVSb3V0ZXIuYXR0YWNoTGlua0hhbmRsZXJzKHRoaXMuc2hhZG93Um9vdCk7XG4gICAgICB9XG4gIH1cbn0pOyJdLCJzb3VyY2VSb290IjoiIn0=